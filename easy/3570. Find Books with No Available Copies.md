# 3570. Find Books with No Available Copies

**Data:** 12/01/2026  
**Dificuldade:** Easy  
**Tópicos:** SQL, CTE, LEFT JOIN, GROUP BY, COALESCE  
**Link:** https://leetcode.com/problems/find-books-with-no-available-copies/description/

## Descrição
Escreva uma solução para encontrar os livros que **não possuem cópias disponíveis no momento**.

Um livro é considerado sem cópias disponíveis quando:
- Todas as suas cópias estão emprestadas atualmente, ou
- O livro possui `total_copies = 0`.

Para isso, devemos:
- Contar quantos empréstimos ativos cada livro possui (onde `return_date IS NULL`)
- Comparar essa quantidade com o total de cópias existentes do livro.

---

## Solução (SQL Server)

```sql
WITH borrowed_books AS (
    SELECT 
        br.book_id,
        COUNT(*) AS current_borrowers
    FROM borrowing_records br
    WHERE br.return_date IS NULL
    GROUP BY br.book_id
)
SELECT 
    bk.book_id,
    bk.title,
    bk.author,
    bk.genre,
    bk.publication_year,
    COALESCE(bb.current_borrowers, 0) AS current_borrowers
FROM library_books bk
LEFT JOIN borrowed_books bb 
    ON bk.book_id = bb.book_id
WHERE 
    -- Todas as cópias estão emprestadas
    COALESCE(bb.current_borrowers, 0) = bk.total_copies
    
    -- Ou o livro não possui cópias cadastradas
    OR (bb.current_borrowers IS NULL AND bk.total_copies = 0)
ORDER BY 
    current_borrowers DESC, 
    bk.title ASC;
