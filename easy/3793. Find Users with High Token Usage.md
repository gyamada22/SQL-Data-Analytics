# 3793. Find Users with High Token Usage

**Data:** 16/01/2026  
**Dificuldade:** Easy  
**Tópicos:** SQL, CTE, GROUP BY, HAVING  
**Link:** [Find Users with High Token Usage - LeetCode](https://leetcode.com/problems/find-users-with-high-token-usage/description/)

## Descrição
Encontre os usuários que:
- Fizeram **pelo menos 3 prompts**.
- Possuem **ao menos um prompt** com `tokens` maior que a **média de tokens** do próprio usuário.

Retorne:
- `user_id`
- Quantidade de prompts (`prompt_count`)
- Média de tokens (`avg_tokens`)

Ordene por:
1. `avg_tokens` decrescente  
2. `user_id` crescente  

## Solução (SQL)

```sql
WITH user_stats AS (
    SELECT  
        user_id,
        COUNT(prompt) AS prompt_count,
        CAST(AVG(tokens * 1.0) AS DECIMAL(10,2)) AS avg_tokens
    FROM prompts
    GROUP BY user_id
    HAVING COUNT(prompt) >= 3
),
high_usage_users AS (
    SELECT DISTINCT pr.user_id
    FROM prompts pr
    JOIN user_stats us 
        ON pr.user_id = us.user_id
    WHERE pr.tokens > us.avg_tokens
)
SELECT  
    hu.user_id,
    us.prompt_count,
    us.avg_tokens
FROM high_usage_users hu
JOIN user_stats us 
    ON hu.user_id = us.user_id
ORDER BY us.avg_tokens DESC, hu.user_id ASC;
