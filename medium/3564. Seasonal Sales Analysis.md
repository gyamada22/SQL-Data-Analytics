# 3564. Seasonal Sales Analysis

**Data:** 26/01/2026  
**Dificuldade:** Medium  
**Tópicos:** SQL, CTE, Window Function, CASE, Aggregation, Ranking  
**Link:** https://leetcode.com/problems/seasonal-sales-analysis/description/?envType=problem-list-v2&envId=vszzv79m  

## Descrição
O objetivo é identificar, para cada estação do ano, a categoria de produto com melhor desempenho.  
O critério de escolha é:

1. Maior **quantidade total vendida**;
2. Em caso de empate, maior **receita total**;
3. Persistindo o empate, a categoria em ordem **alfabética**.

Além disso, o resultado final deve ser ordenado manualmente no seguinte padrão de estações:
**Fall → Spring → Summer → Winter**.

Para isso:
- Primeiro associamos cada venda a uma estação do ano com base no mês da `sale_date`;
- Depois calculamos o total de quantidade e receita por `(season, category)`;
- Em seguida ranqueamos as categorias dentro de cada estação;
- Por fim, selecionamos apenas a categoria vencedora de cada estação.

---

## Solução (SQL Server)
```sql
WITH qwe AS (
    SELECT 
        CASE 
            WHEN MONTH(sale_date) IN (12, 1, 2) THEN 'Winter'
            WHEN MONTH(sale_date) IN (3, 4, 5) THEN 'Spring'
            WHEN MONTH(sale_date) IN (6, 7, 8) THEN 'Summer'
            WHEN MONTH(sale_date) IN (9, 10, 11) THEN 'Fall' 
        END AS season,
        p.category,
        s.quantity,
        s.price
    FROM sales s 
    JOIN products p 
      ON s.product_id = p.product_id
),
qwer AS (
    SELECT  
        season,
        category,
        SUM(quantity) OVER (PARTITION BY season, category) AS total_quantity,
        SUM(quantity * price) OVER (PARTITION BY season, category) AS total_revenue
    FROM qwe            
),
qwert AS (
    SELECT  
        season, 
        category, 
        total_quantity, 
        total_revenue,
        ROW_NUMBER() OVER (
            PARTITION BY season 
            ORDER BY 
                total_quantity DESC,
                total_revenue DESC,
                category ASC
        ) AS rn
    FROM qwer
)

SELECT 
    season,
    category, 
    total_quantity, 
    total_revenue
FROM qwert
WHERE rn = 1
ORDER BY CASE
    WHEN season = 'Fall' THEN 1
    WHEN season = 'Spring' THEN 2
    WHEN season = 'Summer' THEN 3
    WHEN season = 'Winter' THEN 4
END;
