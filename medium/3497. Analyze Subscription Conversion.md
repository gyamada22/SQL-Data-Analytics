# 3497. Analyze Subscription Conversion

**Data:** 20/01  
**Dificuldade:** Medium  
**Tópicos:** SQL, CTE, GROUP BY, AVG, JOIN  
**Link:** https://leetcode.com/problems/analyze-subscription-conversion/description/?envType=problem-list-v2&envId=vszzv79m  

## Descrição
O objetivo é analisar o comportamento dos usuários antes e depois da conversão para um plano pago.  
Para isso, precisamos calcular, para cada usuário:

- A duração média das atividades no período de **free trial**.
- A duração média das atividades no período **paid**.

Apenas usuários que possuem registros em ambos os tipos de atividade devem aparecer no resultado final.

## Solução (SQL Server)
```sql
WITH qwe AS (
    SELECT  
        user_id,
        ROUND(AVG(activity_duration * 1.0), 2) AS ft
    FROM UserActivity
    WHERE activity_type = 'free_trial'
    GROUP BY user_id
),
qwer AS (
    SELECT  
        user_id,
        ROUND(AVG(activity_duration * 1.0), 2) AS pd
    FROM UserActivity
    WHERE activity_type = 'paid'
    GROUP BY user_id
)

SELECT  
    qwe.user_id,
    ft AS trial_avg_duration,
    pd AS paid_avg_duration
FROM qwe 
JOIN qwer 
  ON qwe.user_id = qwer.user_id;
