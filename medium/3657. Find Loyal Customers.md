# 3657. Find Loyal Customers

**Data:** 25/01/2026  
**Dificuldade:** Medium  
**Tópicos:** SQL, CTE, GROUP BY, CASE, Aggregation, Filtering  
**Link:** https://leetcode.com/problems/find-loyal-customers/description/?envType=problem-list-v2&envId=vszzv79m  

## Descrição
O objetivo é identificar os clientes mais leais com base em três critérios principais:

- Ter realizado pelo menos **3 compras**;
- Possuir uma taxa de reembolso menor que **20%** em relação ao total de transações;
- Ter permanecido ativo por pelo menos **30 dias**, considerando a diferença entre a primeira e a última transação.

Para isso, precisamos resumir o histórico de transações de cada cliente, contando compras, reembolsos e calculando o período de atividade.

---

## Solução (SQL Server)
```sql
WITH qwe AS (
    SELECT  
        customer_id,
        SUM(CASE WHEN transaction_type = 'purchase' THEN 1 ELSE 0 END) AS cnt_pur,
        SUM(CASE WHEN transaction_type = 'refund' THEN 1 ELSE 0 END) AS cnt_ref,
        DATEDIFF(
            day, 
            MIN(transaction_date), 
            MAX(transaction_date)
        ) AS active_days
    FROM customer_transactions
    GROUP BY customer_id
)

SELECT customer_id
FROM qwe
WHERE cnt_pur >= 3
  AND (cnt_ref * 1.0 / (cnt_pur + cnt_ref)) < 0.2
  AND active_days >= 30
ORDER BY customer_id;
